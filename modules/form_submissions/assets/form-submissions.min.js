"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),FormSubmissions=function(){function e(){_classCallCheck(this,e),this.trTmplLoc=baseURL("modules/form_submissions/assets/form-submissions-tr-tmpl.html"),this.modalTmplLoc=baseURL("modules/form_submissions/assets/form-submission-modal-body-tmpl.html"),this.apiURL=baseURL("panel/form-submissions/get-submission-data"),this.deleteURL=baseURL("panel/form-submissions/delete-submission"),this.searchURL=baseURL("panel/form-submissions/search-submission"),this.trContainer=document.getElementById("form-submission-row-container"),this.modalBody=document.querySelector("#form-submission-modal .modal-body"),this.searchResultContainer=document.querySelector("#form-submission-result"),this.searchInput=document.querySelector("#form-submission-search"),this.counterSpan=document.querySelector("#count-placeholder"),this.currAccessor=document.body.querySelector("[data-accessor-name]").dataset.accessorName,this.rowData=[],this.trTmpl=null,this.modalBodyTmpl=null,this.page=1,this.size=13,this.init()}return _createClass(e,[{key:"init",value:function(){var o=this;this.handelSearch(),this.fetchTrTemplates().then(function(){o.getSubmissionData("0").then(function(e){var t=e.data,n=void 0===t?[]:t,i=e.allCount;n.forEach(function(e){o.mapDataAndRenderRow(e)}),o.initPagination(i)})})}},{key:"mapDataAndRenderRow",value:function(e){if(e){var t=this.trTmpl,n="row-id-"+e.sub_id;t=this.findAndReplace(t,"ROW_ID",n),t=this.findAndReplace(t,"SUB_ID",e.sub_id),t=this.findAndReplace(t,"SUBJECT",e.subject),t=this.findAndReplace(t,"NAME",e.fullname),t=this.findAndReplace(t,"EMAIL",e.email),t=this.findAndReplace(t,"PHONE",e.phone),t=this.findAndReplace(t,"DATE",this.getFormatedDate(e.delivered_on)),t=this.findAndReplace(t,"LINK",this.getPageURL(e.page_url)),this.renderTrRow(t),this.handleTrRowClick(n)}}},{key:"getPageURL",value:function(){return"<a href='"+(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"/")+"' target='_blank'>Click Here</a>"}},{key:"renderTrRow",value:function(e){this.trContainer.insertAdjacentHTML("beforeend",e)}},{key:"fetchTrTemplates",value:function(){var t=this;window.toggleLoading();var e=fetch(this.trTmplLoc,{headers:{"Cache-Control":"no-cache"}}).then(function(e){return e.text()}).then(function(e){return t.trTmpl=e,!0}),n=fetch(this.modalTmplLoc,{headers:{"Cache-Control":"no-cache"}}).then(function(e){return e.text()}).then(function(e){return t.modalBodyTmpl=e,!0});return Promise.all([e,n]).then(function(e){window.toggleLoading(!1)})}},{key:"getSubmissionData",value:function(){var t=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,n=null!==e?e:this.page;window.toggleLoading();var i=this.apiURL+"/"+this.currAccessor+"/"+n+"/"+this.size;return fetch(i).then(function(e){return e.json()}).then(function(e){if(e.success)return t.trContainer.innerHTML="",t.renderSubmissionCounter({total:e.allCount,showing:e.currCount}),t.rowData=e.data,0===e.allCount?t.showNoSubmissionView():t.showHasSubmissionView(),Promise.resolve(e);console.error(e),showMessage("Something went wrong")}).catch(function(e){return console.error(e),showMessage("Something went wrong"),Promise.reject(!1)}).finally(function(){window.toggleLoading(!1)})}},{key:"handleTrRowClick",value:function(t){var i=this,o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.rowData;setTimeout(function(){var e=document.getElementById(t),n=e.getAttribute("data-sub-id");e&&e.addEventListener("click",function(e){if(e.target.classList.contains("cms-delete-trigger"))i.handleDelete(n,e);else{var t=o.find(function(e){return e.sub_id===n});i.openModal(t)}})},500)}},{key:"openModal",value:function(e){this.mapDataAndRenderModalBody(e),$("#form-submission-modal").modal()}},{key:"mapDataAndRenderModalBody",value:function(e){if(e){var t=this.modalBodyTmpl;t=this.findAndReplace(t,"SUB_ID",e.sub_id),t=this.findAndReplace(t,"SUBJECT",e.subject),t=this.findAndReplace(t,"NAME",e.fullname),t=this.findAndReplace(t,"EMAIL",e.email),t=this.findAndReplace(t,"PHONE",e.phone),t=this.findAndReplace(t,"URL",e.page_url),t=this.findAndReplace(t,"LOCATION",e.location),t=this.findAndReplace(t,"SUB_DATA",this.getSubData(e.sub_data).join(" ")),t=this.findAndReplace(t,"IP",e.id_address),t=this.findAndReplace(t,"DATE",this.getFormatedDate(e.delivered_on)),t=this.findAndReplace(t,"LINK",this.getPageURL(e.page_url)),this.renderModalBody(t)}}},{key:"getSubData",value:function(e){return JSON.parse(e).map(function(e){return"\n      <tr class="+("DOUBLE"===e.type?"double-size":"")+">\n        <td class='modal-cell-caption'>"+e.caption+": </td>\n        <td>"+e.data+"</td>\n      </tr>\n    "})}},{key:"renderModalBody",value:function(e){this.modalBody.innerHTML="",this.modalBody.insertAdjacentHTML("beforeend",e)}},{key:"handleDelete",value:function(t,n){var i=this;popup.confirm({content:"Are you sure you want to delete this submission?",backdrop_close:!1},function(e){e.proceed&&(i.postDeleteAPI(t),n.target.parentNode.parentNode.remove())})}},{key:"postDeleteAPI",value:function(e){var t=baseURL("panel/operations/push-delete/"+id);fetch(t,{method:"POST",body:JSON.stringify({subID:e})}).then(function(e){return e.json()}).then(function(e){console.log(e)})}},{key:"handelSearch",value:function(){var n=this;this.searchInput.addEventListener("keyup",function(t){setTimeout(function(){var e=t.target.value.trim();e&&4<e.length?n.getSearchData(e).then(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];e.length?(n.renderSearchItems(e),n.toggleSearchResultContainer()):n.toggleSearchResultContainer(!1)}):n.toggleSearchResultContainer(!1)},800)})}},{key:"renderSearchItems",value:function(n){var i=this,e=n.map(function(e){var t="search-row-id-"+e.sub_id;return i.handleTrRowClick(t,n),'\n        <tr id="'+t+'" data-sub-id="'+e.sub_id+'">\n          <td>'+e.fullname+"</td>\n          <td>"+e.email+"</td>\n          <td>"+e.phone+"</td>\n          <td>"+i.getFormatedDate(e.delivered_on)+"</td>\n        </tr>\n      "}),t=this.searchResultContainer.querySelector("table tbody");t.innerHTML="",t.insertAdjacentHTML("beforeend",e.join(" "))}},{key:"getSearchData",value:function(e){var t=this.searchURL+"/"+this.currAccessor+"/"+e;return fetch(t).then(function(e){return e.json()}).then(function(e){return Promise.resolve(e)})}},{key:"toggleSearchResultContainer",value:function(){!(0<arguments.length&&void 0!==arguments[0])||arguments[0]?this.searchResultContainer.classList.add("show"):this.searchResultContainer.classList.remove("show")}},{key:"findAndReplace",value:function(e,t,n){var i="{{"+t+"}}";return e.replace(i,n).replace(i,n).replace(i,n)}},{key:"initPagination",value:function(e){var n=this;$("#pagination-container").pagination({items:e,itemsOnPage:this.size,onPageClick:function(e){n.page=n.size*(e-1),n.getSubmissionData().then(function(e){var t=e.data;(void 0===t?[]:t).forEach(function(e){n.mapDataAndRenderRow(e)})})}})}},{key:"getFormatedDate",value:function(e){return timeAgo(e)}},{key:"renderSubmissionCounter",value:function(e){var t=e.total,n=e.showing;this.counterSpan.innerHTML=n+"/"+t}},{key:"showNoSubmissionView",value:function(){$("#no-submission-view").css({display:"flex"})}},{key:"showHasSubmissionView",value:function(){$("#has-submission-view").show()}}]),e}();$("document").ready(function(){new FormSubmissions});
//# sourceMappingURL=form-submissions.min.js.map